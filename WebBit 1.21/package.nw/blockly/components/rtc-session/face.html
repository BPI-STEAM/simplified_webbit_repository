<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="bower_components/firebase/firebase.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/facade.js/facade.min.js"></script>
  <script src="lib/RTCMultiConnection.min.js"></script>
  <script src="lib/RTCSession.js"></script>
  <script src="lib/FaceAPI.js"></script>
</head>

<body>
  <div>
    <p>
      <label for="sessionId">Session</label>
      <input id="sessionId" placeholder="sessionid" size="8" />
      <label for="password">Password</label>
      <input id="password" placeholder="password" size="8" />
    </p>
    <p>
      <input type="radio" id="hostOption" name="openType" value="host" checked />
      <label for="hostOption">host</label>
      <input type="radio" id="openOption" name="openType" value="join" />
      <label for="openOption">join</label>
    </p>
    <p>
      <input type="radio" id="detect" name="detectType" value="detect" checked />
      <label for="detect">人臉</label>
      <input type="radio" id="emotion" name="detectType" value="emotion" />
      <label for="emotion">情緒</label>
      <input type="radio" id="describe" name="detectType" value="describe" />
      <label for="describe">描述</label>
    </p>
    <p>
      <span>影像來源</span>
      <select id="sourceType" onchange="changeType()">
        <option value="none">None</option>
        <option value="remote">Signalling Server IP</option>
        <option value="user">User Media</option>
      </select>
      <input id="sourceValue" placeholder="localhost" size="30" style="display: none" />
      <button id="btn" onclick="connect()">START</button>
    </p>
  </div>
  <video></video>
  <script>
  var session, faceAPI;
  var params = {
    "returnFaceLandmarks": true,
    "returnFaceAttributes": "age,gender,headPose,smile,facialHair,glasses"
  };

  function changeType() {
    var type = document.querySelector('#sourceType').value;
    document.querySelector('#sourceValue').style.display = (type === 'remote' ? '' : 'none');
  }

  function connect() {
    var sessionId = document.querySelector('#sessionId').value || document.querySelector('#sessionId').placeholder,
      password = document.querySelector('#password').value || document.querySelector('#password').placeholder,
      sourceType = document.querySelector('#sourceType').value,
      sourceValue = document.querySelector('#sourceValue').value || document.querySelector('#sourceValue').placeholder,
      openType = document.querySelector('input[name=openType]:checked').value,
      detectType = document.querySelector('input[name=detectType]:checked').value,
      doCapture = sourceType === 'user';

    session = new RTCSession(sessionId, password, doCapture);
    faceAPI = new FaceAPI({
      emotion: '425fab09e22842a8ac147b294449be98',
      detect: 'd7968929cf5e4d45816bc18182c8c852',
      describe: '783b76c2be2940f3a05d2660f38b18f0'
    }[detectType], detectType);
    // var faceAPI = new FaceAPI('d7968929cf5e4d45816bc18182c8c852'); // BizSpark + detect

    session.onstream = function(evt) {
      evt.mediaElement.width = 640;
      document.body.replaceChild(evt.mediaElement, document.querySelector('video'));
      delete session.onstream;
      document.querySelector('#btn').disabled = 'disabled';
      faceAPI.detectAndShow(params, evt.mediaElement, 3000);
    };

    session.onstreamended = function(evt) {
      faceAPI.stopDetect();
      evt.mediaElement.style.opacity = 0;
      setTimeout(function() {
        if (evt.mediaElement.parentNode) {
          evt.mediaElement.parentNode.removeChild(evt.mediaElement);
        }
      }, 1000);
    };

    session.onstatechange = function(state) {
      if (state.name == 'request-rejected') {
        alert(state.reason);
      }
    };

    if (openType === 'host') {
      session.open();
    }

    if (sourceType === 'remote') {
      session.attachRemote('ws://' + sourceValue + ':8080/stream/webrtc');
    }
  }
  </script>
</body>

</html>
