<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="bower_components/firebase/firebase.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="lib/RTCMultiConnection.min.js"></script>
  <script src="lib/RTCSession.js"></script>
  <script src="lib/FaceAPI.js"></script>
  <script src="lib/mqttws31.min.js"></script>
</head>

<body>
  <script>
  var roomId = 'session-name';
  var session = new RTCSession(roomId, 'password', true);
  // var faceAPI = new FaceAPI('d7968929cf5e4d45816bc18182c8c852'); // BizSpark
  var faceAPI = new FaceAPI('4483abb5991444498db013366d91a6b0'); // Free
  var inFlight;
  var capItvl;
  var client;

  session.onstream = function(evt) {
    evt.mediaElement.width = 320;
    document.body.appendChild(evt.mediaElement);
    delete session.onstream;
    hookWebSocket();
    detect(evt.streamid, 2000);
  };

  session.onstreamended = function(evt) {
    evt.mediaElement.style.opacity = 0;
    setTimeout(function() {
      if (evt.mediaElement.parentNode) {
        evt.mediaElement.parentNode.removeChild(evt.mediaElement);
      }
    }, 1000);

    if (capItvl) {
      clearInterval(capItvl);
      capItvl = null;
    }
  };

  session.open();

  function detect(streamId, interval) {
    var stream = session.connection.streams[streamId],
      params = {
        "returnFaceLandmarks": true,
        "returnFaceAttributes": "age,gender,headPose,smile,facialHair,glasses"
      };

    capItvl = setInterval(function() {
      stream.takeSnapshot(function(dataURL) {
        if (!inFlight) {
          inFlight = true;
          faceAPI.detect(params, dataURL).always(function(dataList) {
            inFlight = false;
            if (dataList.hasOwnProperty('length')) {
              addData(dataList);
              sendWebSocket(dataList);
            }
          });
        }
      });
    }, interval);
  }

  function addData(dataList) {
    return $.ajax({
      method: 'post',
      contentType: 'application/json',
      url: '/api/faceData',
      data: JSON.stringify(dataList.map(function(d) {
        return {
          faceAttributes: d.faceAttributes
        }
      }))
    });
  }

  function sendWebSocket(dataList) {
    dataList = new Paho.MQTT.Message(JSON.stringify(
      dataList.map(function(data) {
        return {
          faceAttributes: data.faceAttributes,
          faceRectangle: data.faceRectangle
        };
      })
    ));
    dataList.destinationName = roomId + '/faceData';
    client && client.send(dataList);
  }

  function hookWebSocket() {
    client = new Paho.MQTT.Client('ws://' + location.host + '/', '_' + Date.now());
    client.connect({
      userName: 'admin',
      password: 'password',
      timeout: 60,
      keepAliveInterval: 5,
      onFailure: onError
    });
  }

  function onError(respObj) {
    console.error(
      new Date().toLocaleString(),
      'error',
      respObj.errorMessage
    );
  }
  </script>
</body>

</html>
