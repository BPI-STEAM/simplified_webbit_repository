<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="bower_components/firebase/firebase.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/facade.js/facade.min.js"></script>
  <script src="lib/RTCMultiConnection.min.js"></script>
  <script src="lib/RTCSession.js"></script>
  <script src="lib/mqttws31.min.js"></script>
</head>

<body>
  <script>
  var roomId = 'session-name';
  var session = new RTCSession(roomId, 'password');
  var client;
  var stage;

  session.onstream = function(evt) {
    var canvas = document.createElement('canvas'),
      video = evt.mediaElement;

    video.width = 320;
    document.body.appendChild(video);

    canvas.id = video.id + '-canvas';
    canvas.style.position = 'absolute';
    canvas.style.left = (video.offsetLeft - video.scrollLeft) + 'px';
    canvas.style.top = (video.offsetTop - video.scrollTop) + 'px';
    canvas.width = 320;
    canvas.height = 240;
    document.body.insertBefore(canvas, video.nextSibling);

    delete session.onstream;
    hookWebSocket();
  };

  session.onstreamended = function(evt) {
    var video = evt.mediaElement,
      body = document.body,
      canvas = document.querySelector('#' + video.id + '-canvas');

    body.removeChild(canvas);
    video.style.opacity = 0;
    setTimeout(function() {
      if (body) {
        body.removeChild(video);
      }
    }, 1000);
  };

  session.onstatechange = function(state) {
    if (state.name == 'request-rejected') {
      alert(state.reason);
    }
  };

  function hookWebSocket() {
    client = new Paho.MQTT.Client('ws://' + location.host + '/', '_' + Date.now());
    client.onMessageArrived = onMessage;
    client.connect({
      userName: 'admin',
      password: 'password',
      timeout: 60,
      keepAliveInterval: 5,
      onSuccess: onConnect,
      onFailure: onError
    });
  }

  function onMessage(message) {
    var msg = message.payloadString;

    updateCanvas(JSON.parse(msg), function(attrs) {
      return [
        '性別：' + {
          male: '男',
          female: '女'
        }[attrs.gender],
        '年齡：' + attrs.age,
        '笑容：' + ((attrs.smile || 0) * 100).toFixed() + ' %',
        '眼鏡：' + {
          ReadingGlasses: '一般',
          SunGlasses: '墨鏡',
          SwimmingGoggles: '蛙鏡',
          NoGlasses: '無'
        }[attrs.glasses],
        '鬍子：' + attrs.facialHair.moustache,
        '鬍鬚：' + attrs.facialHair.beard,
        '鬢角：' + attrs.facialHair.sideburns,
      ].join('\n');
    });
  }

  function onConnect() {
    client.subscribe(roomId + '/faceData');
  }

  function onError(respObj) {
    console.error(
      new Date().toLocaleString(),
      'error',
      respObj.errorMessage
    );
  }

  function updateCanvas(dataList, textFormatter) {
    var rectDefaults = {
        x: 0,
        y: 0,
        width: 100,
        height: 100,
        lineWidth: 1,
        strokeStyle: 'white',
        fillStyle: 'rgba(0, 0, 0, 0)',
        anchor: 'top/left'
      },
      textDefaults = {
        x: 2,
        y: 1,
        fontFamily: 'Helvetica',
        fontSize: 20,
        fillStyle: 'white',
        anchor: 'top/left'
      };

    stage = stage || new Facade(document.querySelector('canvas'));
    stage.clear();

    dataList.forEach(function(data, idx) {
      var faceRectangle = data.faceRectangle,
        faceAttributes = data.faceAttributes;

      var rectOption = $.extend({}, rectDefaults, {
        x: faceRectangle.left,
        y: faceRectangle.top,
        width: faceRectangle.width,
        height: faceRectangle.height,
        rotate: faceAttributes.headPose.roll
      });

      var textOption = $.extend({}, textDefaults, {
        x: rectOption.x > stage.canvas.clientWidth - 100 - rectOption.width ? rectOption.x - 110 : 10 + faceRectangle.width + rectOption.x,
        y: rectOption.y,
        rotate: faceAttributes.headPose.roll
      });

      stage.addToStage(new Facade.Rect(rectOption));
      stage.addToStage(new Facade.Text(textFormatter(data.faceAttributes), textOption));
    });
  }
  </script>
</body>

</html>
