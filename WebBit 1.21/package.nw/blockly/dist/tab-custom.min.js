!function(t,o){"use strict";var e=!1,n="blocks";function c(t){try{var e=Blockly.Xml.textToDom(t);Blockly.mainWorkspace.clear(),Blockly.Xml.domToWorkspace(e,o.workspace),o.tabClick("blocks")}catch(t){BlocklyStorage.alert(MSG.importInvalid,"error")}}function r(e,n){var c=t.localStorage.customBlocks||"";switch(c=c?JSON.parse(c):[],e){case"add":c.push(n);break;case"remove":c=c.filter(function(t){return t!==n})}return t.localStorage.setItem("customBlocks",JSON.stringify(c)),Promise.resolve().then(function(){return o.loadBlockDefs(n)}).then(function(t){switch(e){case"add":o.addToolbox(t.category,t.toolboxXml),$(".form-custom-blocks .info").html(MSG.customBlockImportSuccess).css({color:"blue"});break;case"remove":o.removeToolbox(t.category,t.toolboxXml),$(".form-custom-blocks .info").html(MSG.customBlockRemoveSuccess).css({color:"blue"})}return o.workspace.updateToolbox(o.getToolBox()),Promise.resolve(!0)})}function s(t){$(".form-custom-blocks .info").html(t).css({color:"red"}),$(".input-custom-blocks").css({"box-shadow":"inset red 0 0 3px"}),$(".input-custom-blocks").one("input",function(){$(".form-custom-blocks .info").html(""),$(this).css({"box-shadow":"inset #999 0 0 3px"})})}function l(t){var o=!0;return t&&"object"==typeof t?($.each(["types","dependencies"],function(e,n){if(!t[n]||!$.isArray(t[n]))return o=!1}),$.each(["category","toolbox"],function(e,n){if(!t[n]||"string"!=typeof t[n])return o=!1}),o):o=!1}function a(){var o=t.localStorage.customBlocks||[];return o&&(o="object"==typeof o?o:JSON.parse(o)),o}o.customTab={init:function(){$(".text-custom-description").html(MSG.customDescription.replace("%1","<code>(blockly.json)</code>")),$("#importFileBtn").on("click",function(t){var o=new FileReader;return t.preventDefault(),!!$("#chooseFile").val()&&!!confirm(MSG.importWarning)&&(o.onload=function(){c(o.result)},void o.readAsText($("#chooseFile")[0].files[0]))}),$("#importFromUrlBtn").on("click",function(t){var o=/^[http|https]+:\/\/blockly\.webduino\.io\/\?*.*#(.*)$/;swal({text:MSG.importUrlText,content:{element:"input",attributes:{placeholder:"http://blockly.webduino.io/?#abcd1234"}}}).then(function(t){if(t){var e=o.exec(t);if(e){var n=e[1];$.getJSON("https://glowing-fire-4998.firebaseio.com/blockly/"+n+".json",function(t){if(!confirm(MSG.importWarning))return!1;c(t.xml)})}else BlocklyStorage.alert(MSG.importInvalid,"error")}})}),$(".tab-trigger").on("click",function(){var t=$(this),o=t.data("tab");console.log("come here"),$(".tab-trigger").removeClass("active"),t.addClass("active"),$(".tab-content").hide(),$('.tab-content[data-tab="'+o+'"]').show().css("display","flex")}),$(".form-custom-blocks").on("submit",function(t){console.log("成了");var o=/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/,e=$(".input-custom-blocks").val();t.preventDefault(),e.indexOf("https://")<0&&e.indexOf("http://")<0&&(e="https://"+e,$(".input-custom-blocks").val(e));var n='<div class="block-def"><a href="'+e+'" title="'+e+'" class="custom-def-link" target="_blank">'+e+'</a> <button class="btn btn-remove-block">'+MSG.customBlockRemove+"</button></div>";$.getJSON(e).done(function(t,o,c){var a=c.getResponseHeader("content-type");if(a.indexOf("json")<0)return s(MSG.customBlockMIMEInvalid),!1;l(t)?($(".block-def-wrapper").append(n),$(".input-custom-blocks").val(""),r("add",e)):s(MSG.customBlockInvalid)}).fail(function(t,n,c){404!==t.status?o.test(e)?s(MSG.customBlockLinkInvalid):s(MSG.customBlockUnknownError+" ("+n+": "+c+")"):s(MSG.customBlockNotFound)})}),$("#content_custom .block-def-wrapper").on("click",".btn-remove-block",function(){var t=o.workspace.getAllBlocks().map(function(t){return t.type}),e=$(this),n=e.prev().text();$.getJSON(n).done(function(o){var c=o.types.every(function(o){return-1===t.indexOf(o)});c?r("remove",n).then(function(){e.parent().remove()}).catch(function(t){console.log(t)}):alert(MSG.customBlockInUse)}).fail(function(t,o,c){e.parent().remove(),r("remove",n)})})},open:function(){if(e=!0,$("#tab_custom").html('<i class="icon-cross"></i>'),"localStorage"in t){var n=t.localStorage.customBlocks,c="";n&&((n="object"==typeof n?n:JSON.parse(n)).forEach(function(t){c+='<div class="block-def"><a href="'+t+'" title="'+t+'" class="custom-def-link" target="_blank">'+t+'</a> <button class="btn btn-remove-block">'+MSG.customBlockRemove+"</button></div>"}),$(".block-def-wrapper").html(c))}var r=$("#btn-export-blocks"),s=Blockly.Xml.workspaceToDom(o.workspace),l=Blockly.Xml.domToPrettyText(s);r.attr({download:"blockly.xml",href:"data:application/octet-stream,"+encodeURIComponent(l)})},close:function(t){e=!1,$("#tab_custom").html('<i class="icon-cog"></i>'),t?n=t:o.tabClick(n)},isOpen:function(){return e},$__add__:function(t){var o=/^(http:\/\/www\.|https:\/\/www\.|http:\/\/|https:\/\/)?[a-z0-9]+([\-\.]{1}[a-z0-9]+)*\.[a-z]{2,5}(:[0-9]{1,5})?(\/.*)?$/;return t.indexOf("https://")<0&&t.indexOf("http://")<0&&(t="https://"+t),axios.get(t).then(function(o){return o.headers["content-type"].indexOf("json")<0?{status:!1,message:MSG.customBlockMIMEInvalid,url:t}:l(o.data)?r("add",t).then(function(){return{status:!0,url:t}}):{status:!1,message:MSG.customBlockInvalid,url:t}}).catch(function(e){var n=MSG.customBlockUnknownError;return e.response&&404===e.response.status?n=MSG.customBlockNotFound:o.test(t)&&(n=MSG.customBlockLinkInvalid),{status:!1,message:n,url:t,error:e}})},$__remove__:function(t){var e=o.workspace.getAllBlocks().map(function(t){return t.type});return a().indexOf(t)<0?Promise.resolve({status:!1,url:t,message:"The url is invalid. Please do $__query__ to get the correct."}):axios.get(t).then(function(o){return o.data.types.every(function(t){return-1===e.indexOf(t)})?r("remove",t).then(function(){return{status:!0,url:t}}):{status:!1,url:t,message:MSG.customBlockInUse}}).catch(function(o){return r("remove",t).then(function(){return{status:!1,url:t,error:o}})})},$__query__:a}}(window,window.Code);