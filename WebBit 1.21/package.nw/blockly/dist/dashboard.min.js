!function(){"use strict";var e,t=app.models.user,i=(app.models.group,app.models.project);var a=function(){$(".js-myfile-table").bootstrapTable("refresh"),$(".btn-batch").attr("disabled",!0),$.getJSON("/api/users/"+Token.getUserId()+"/getProjectCount?access_token="+Token.getId(),function(e){var t=e.count+"/"+e.limit;d(Math.round(e.count/e.limit*360)),e.available<=0?$(".js-add").attr("disabled",!0):$(".js-add").attr("disabled",!1),$(".project-count").text(t)})};var n,l,o=function(e){var t=$.map(e,function(e){if(e.xml||(e.xml='<xml xmlns="http://www.w3.org/1999/xhtml"></xml>'),e.customBlocks||(e.customBlocks=[]),!e.name){var t=new Date;e.name=t.getTime()}return{xml:e.xml,name:e.name,customBlocks:e.customBlocks}});return new Promise(function(e,i){$.ajax({url:"/api/users/"+Token.getUserId()+"/projects/create?access_token="+Token.getId(),method:"POST",contentType:"application/json; charset=utf-8",dataType:"JSON",data:JSON.stringify(t),success:function(t){a(),e(t)},error:function(e,t,n){var l=e.responseJSON;a(),i(l)}})})};function s(){var t=$(".dashboard-nav"),i=$("#edit-area");t.on("show.bs.collapse hide.bs.collapse",function(e){$(e.target).parent().toggleClass("open")}),t.on("click","li",function(e){e.target.getAttribute("data-toggle")||(t.find("li").removeClass("active"),$(e.target).parent().addClass("active"))}),t.on("click","[data-target]",function(e){var t=e.target.getAttribute("data-target"),a=$("div."+t).data("table");i[0].className=t,$(a).bootstrapTable("refresh")}),$(".js-add").on("click",function(){$(".js-newFile").on("shown.bs.modal",function(){$("#newFile").focus()})}),$("#shareToUser").on("input",function(){$("#shareToTarget").html($("#shareToUser").val().split(",").join("<br>")),$("#shareToName").html($("#sharedFile").text())}),$(".js-profile").on("click",function(){$("#accountContent").collapse("show"),$('[data-target="profile"]').trigger("click")}),$(".form-new-file").on("submit",function(e){e.preventDefault();var t=$("#newFile"),i=i18next.language,a=window.open("","_blank");o([{name:t.val()}]).then(function(e){if(e.project){e.exceedLimit&&$(".alert-limit").find("p").html(i18n.t("blocklyMyFiles.reachLimit",{limit:e.limit})).end().show().addClass("animated flipInX").find(".hide-alert").one("click",function(){$(this).closest(".alert-limit").removeClass("animated flipInX").hide()});var n=e.project[0].hashid;return t.val(""),$(".js-newFile").modal("hide"),"zh-cn"===i?a.location="./?lang=zh-hans#"+n:"en"===i?a.location="./?lang=en#"+n:void(a.location="./#"+n)}}).catch(function(e){console.log(e)})}),$(".form-share-file").on("submit",function(t){t.preventDefault();var i={},n=$("#sharedPK").val().split(",");switch($('input[name="shareMethod"]:checked').val()){case"none":i.shareUser=[],i.shareGroup=[];break;case"specified":i.shareUser=$("#shareToUser").tokenfield("getTokensList").split(", "),i.shareGroup=[];break;case"public":i.shareUser=[],i.shareGroup=["all"];break;case"unlisted":i.shareUser=[],i.shareGroup=["unlisted"]}Promise.all($.map(n,function(t){return e.__updateById__projects(t,i)})).then(function(){$(".blocklyMyFiles .alert-success").show(300).delay(2e3).hide(300),$(".js-sharedInfo").modal("hide"),a()}).catch(function(e){console.error(e)})}),$('[data-toggle="tooltip"]').tooltip({container:"body"}),$('input[name="shareMethod"]:radio').on("change",function(){switch($(this).val()){case"none":$(".share-detail.user").hide(),$(".share-detail.public").hide(),$(".public-description").hide(),$(".unlisted-description").hide();break;case"specified":$(".share-detail.user").show(),$(".share-detail.public").hide(),$(".public-description").hide(),$(".unlisted-description").hide();break;case"public":$(".share-detail.user").hide(),$(".share-detail.public").show(),$(".public-description").show(),$(".unlisted-description").hide();break;case"unlisted":$(".share-detail.user").hide(),$(".share-detail.public").show(),$(".public-description").hide(),$(".unlisted-description").show()}}),$("#newFileName").on("input",function(){""!==$(this).val()?($("#renameInfoText").show(),$("#newFileNameText").html($(this).val())):$("#renameInfoText").hide()}),$(".form-rename-file").on("submit",function(t){var i=$(".js-myfile-table").bootstrapTable("getSelections"),n=i[0];if(t.preventDefault(),1!==i.length)return!1;e.__updateById__projects(n.id,{name:$("#newFileName").val()}).then(function(){a(),$("#renameInfoText").hide(),$(".js-changeName").modal("hide")})}),$(".js-myfile-table, .js-sharedfile-table, .js-publicfile-table").on("click-cell.bs.table",function(e,t,i,a,n){var l=i18next.language;if("name"===t){var o=a.hashid&&""!=a.hashid?a.hashid:a.id;if("zh-cn"===l)return window.open("./?lang=zh-hans#"+o,"_blank");if("en"===l)return window.open("./?lang=en#"+o,"_blank");window.open("./#"+o,"_blank")}}),$(".form-public-search").on("submit",function(e){var t=$(".input-public-search").val(),i=$(".input-public-search").data("prev");if(e.preventDefault(),t===i)return!1;""!==t?($(".blocklyPublicFiles").removeClass("center"),function(e){var t,i=$(".js-publicfile-table");t={locale:"zh-TW",idField:"id",classes:"table table-hover table-no-bordered table-condensed",columns:[{field:"name",title:i18n.t("blocklySharedFiles.fieldTitle.name"),class:"column-name",sortable:!0,valign:"middle"},{field:"user.email",title:i18n.t("blocklySharedFiles.fieldTitle.user"),sortable:!0,valign:"middle"},{field:"modifyTime",title:i18n.t("blocklySharedFiles.fieldTitle.modifyTime"),sortable:!0,valign:"middle",formatter:r}],responseHandler:function(e){return(e=_.remove(e,function(e){return e.userId.toString!==Token.getUserId()})).map(function(e){return e.user.userIdentities&&(e.user.userIdentities.profile.displayName&&""!==e.user.userIdentities.profile.displayName.trim()?e.user.email=e.user.userIdentities.profile.email+" ("+e.user.userIdentities.profile.displayName+")":e.user.email=e.user.userIdentities.profile.email),e})},url:"/api/users/publicProjects/"+e+"?access_token="+Token.getId()},i.bootstrapTable("destroy").bootstrapTable(t).show()}(t)):($(".blocklyPublicFiles").addClass("center"),$(".js-publicfile-table").bootstrapTable("destroy").hide()),$(".input-public-search").data("prev",t)}),$(".js-logout").on("click",function(){logOut()}),$("#language").on("change",function(){var e=c().lang,t=$(this).children("option:selected").get(0).value,i=window.location.host.replace(/:[0-9].*$/,"").split("."),a=i.slice(i.length-2,i.length).join(".");e?(Cookies.set("locale",t,{domain:a}),location=location.href.replace("lang="+e,"lang="+t)):(Cookies.set("locale","zh-tw",{domain:a}),location.search=location.search?location.search+"&lang="+t:"lang="+t)})}function r(e,t,i){return new Date(e).toLocaleString()}function c(){for(var e,t=[],i=location.search.slice(1).split("&"),a=0;a<i.length;a++)e=i[a].split("="),t.push(e[0]),t[e[0]]=e[1];return t}function d(e){e<180?($(".pie").css({width:"10px","margin-left":"10px","border-radius":"0 10px 10px 0"}),$(".pie-before").css({transform:"rotate("+(e-90)+"deg)"}),$(".pie-after").css({opacity:"0"})):($(".pie").css({width:"20px","margin-left":"0","border-radius":"0"}),$(".pie .pie-before").css({transform:"rotate("+(e-90)+"deg)"}),$(".pie .pie-after").css({opacity:"1"}))}$(".pie-chart").on("click",function(){$(this).hasClass("note-open")?$(this).removeClass("note-open"):$(this).hasClass("note-open")||$(this).addClass("note-open")}),n=c().lang||"zh-tw",(l=$("#language")).find("option").each(function(e,t){if(t.value===n)return t.setAttribute("selected",!0),!1}),l.show(),function(e){e=e||function(){};var t={load:"currentOnly",lowerCaseLng:!0,fallbackLng:"zh-tw",preload:["en","zh-tw","zh-cn"],backend:{loadPath:"locales/{{lng}}.json"},detection:{order:["querystring","cookie","navigator"],lookupCookie:"locale",lookupQuerystring:"lang"}};window.i18next.use(window.i18nextBrowserLanguageDetector).use(window.i18nextXHRBackend).init(t,function(i,a){var n=(navigator.language||navigator.browserLanguage).toLowerCase();i&&(-1!==t.preload.indexOf(n)?(i18next.changeLanguage(n),$("#language").val(n)):$("#language").val("en")),window.i18n=window.i18next,window.jqueryI18next.init(window.i18next,$),$("body").localize(),e()})}(function(){var n,l,c,u,h;t.findById(Token.getUserId()).then(function(t){(e=t).__get__userIdentities().then(function(e){$(".email").html('<i class="glyphicon glyphicon-user"></i> '+e.profile.emails[0].value)}).catch(function(t){$(".email").html('<i class="glyphicon glyphicon-user"></i> '+e.email)})}),function(){var t=$(".js-myfile-table"),n=function(e){e?($(".share-detail.public").find(".share-link, .copy, br").hide(),$("#sharedFile").hide(),$(".public-description").html(i18n.t("sharedInfo.publicHelpMultiple")),$(".unlisted-description").html(i18n.t("sharedInfo.unlistedHelpMultiple"))):($(".public-description").html(i18n.t("sharedInfo.publicHelp")),$("#sharedFile").show(),$(".unlisted-description").html(i18n.t("sharedInfo.unlistedHelp2")),$(".share-detail.public").find(".share-link, .copy, br").show())};$('.btn-batch[data-action="share"]').on("click",function(){var e=t.bootstrapTable("getSelections");if(1===e.length){var a=e[0];n(!1),i.findById(a.id).then(function(e){var t="",i=location.origin+"/#"+a.hashid,n=new Clipboard(".copy");e.shareGroup.indexOf("all")>-1?(t="public",$(".share-detail.user").hide(),$(".share-detail.public").show(),$(".public-description").show(),$(".unlisted-description").hide()):e.shareGroup.indexOf("unlisted")>-1?(t="unlisted",$(".share-detail.user").hide(),$(".share-detail.public").show(),$(".public-description").hide(),$(".unlisted-description").show()):e.shareUser.length>0?(t="specified",$(".share-detail.user").show(),$(".share-detail.public").hide()):(t="none",$(".share-detail.user").hide(),$(".share-detail.public").hide()),""!==t?$('input[name="shareMethod"][value="'+t+'"]').prop("checked",!0):$('input[name="shareMethod"]').prop("checked",!1),$(".copy").attr("title",i18n.t("sharedInfo.copyLink")).tooltip("fixTitle"),$(".share-link").attr("href",i).html(i),n.on("success",function(e){$(".copy").attr("title",i18n.t("sharedInfo.copied")).tooltip("fixTitle").tooltip("show"),e.clearSelection()}),$("#shareToUser").tokenfield("destroy").val(e.shareUser.join(",")).tokenfield({createTokensOnBlur:!0}).on("tokenfield:createdtoken",function(e){/\S+@\S+\.\S+/.test(e.attrs.value)||$(e.relatedTarget).addClass("invalid")})}),$(".js-sharedInfo").one("show.bs.modal",function(t){$("#sharedFile").html(a.name),$("#shareToUser").val((a.sharedUser||[]).join(",")),$("#sharedPK").val($.map(e,function(e){return e.id})),a.shareGroup.length>0&&"all"===a.shareGroup[0]&&$("#shareToPublic").attr("checked",!0)})}else n(!0),$(".js-sharedInfo").one("show.bs.modal",function(t){$("#sharedPK").val($.map(e,function(e){return e.id}))})}),$('.btn-batch[data-action="remove"]').on("click",function(){var i=t.bootstrapTable("getSelections");if(1===i.length){var n=i[0];confirm(i18n.t("initMyFileTable.confirmDelete",{name:n.name}))&&e.__destroyById__projects(n.id).then(function(){a()})}else{var l=$.map(i,function(t){return e.__destroyById__projects(t.id)});confirm(i18n.t("initMyFileTable.confirmDelete",{name:i18n.t("initMyFileTable.multiFile")}))&&Promise.all(l).then(function(){a()}).catch(function(e){console.log(e)})}}),$('.btn-batch[data-action="copy"]').on("click",function(){var e=t.bootstrapTable("getSelections"),i=$.map(e,function(e){return{xml:e.xml,name:e.name+i18n.t("blocklyMyFiles.copy-suffix"),customBlocks:e.customBlocks}});o(i).then(function(e){e.exceedLimit&&$(".alert-limit").find("p").html(i18n.t("blocklyMyFiles.reachLimit",{limit:e.limit})).end().show().addClass("animated flipInX").find(".hide-alert").one("click",function(){$(this).closest(".alert-limit").removeClass("animated flipInX").hide()})})}),$(".js-changeName").on("shown.bs.modal",function(){var e=t.bootstrapTable("getSelections"),i=e[0];if(1!==e.length)return!1;$(".oldFileName").html(i.name),$("#newFileName").val(i.name),$("#changedPK").val(i.id),$("#newFileName").focus()});var l=function(){var e=t.bootstrapTable("getSelections").length;0===e?$(".btn-batch").attr("disabled",!0):1===e?$(".btn-batch").attr("disabled",!1):($(".btn-batch").attr("disabled",!1),$('.btn-batch[data-batch="single"]').attr("disabled",!0))};t.bootstrapTable({locale:"zh-TW",idField:"id",formatSearch:function(){return i18n.t("blocklyMyFiles.searchName")},classes:"table table-hover table-no-bordered table-condensed",columns:[{field:"check",checkbox:!0,searchable:!1},{field:"name",title:i18n.t("blocklyMyFiles.fieldTitle.name"),class:"column-name",sortable:!0,searchable:!0,valign:"middle"},{field:"modifyTime",title:i18n.t("blocklyMyFiles.fieldTitle.modifyTime"),sortable:!0,searchable:!1,valign:"middle",formatter:r},{field:"status",title:i18n.t("blocklyMyFiles.fieldTitle.shareStatus"),sortable:!0,searchable:!1,valign:"middle"}],url:"/api/users/"+Token.getUserId()+"/projects?access_token="+Token.getId(),responseHandler:function(e){return e.map(function(e){if(e.shareUser.length>0)return e.status=i18n.t("blocklyMyFiles.shareMethodSpecified"),e;if(e.shareGroup.length>0){if("all"===e.shareGroup[0])return e.status=i18n.t("blocklyMyFiles.shareMethodPublic"),e;if("unlisted"===e.shareGroup[0])return e.status=i18n.t("blocklyMyFiles.shareMethodUnlisted"),e}return e.status=i18n.t("blocklyMyFiles.shareMethodNone"),e})},onCheck:l,onUncheck:l,onCheckAll:l,onUncheckAll:l}),$.getJSON("/api/users/"+Token.getUserId()+"/getProjectCount?access_token="+Token.getId(),function(e){var t=e.count+"/"+e.limit;d(Math.round(e.count/e.limit*360)),e.available<=0?$(".js-add").attr("disabled",!0):$(".js-add").attr("disabled",!1),$(".project-count").text(t)})}(),$(".js-sharedfile-table").bootstrapTable({locale:"zh-TW",idField:"id",formatSearch:function(){return i18n.t("blocklySharedFiles.searchName")},classes:"table table-hover table-no-bordered table-condensed",columns:[{field:"name",title:i18n.t("blocklySharedFiles.fieldTitle.name"),class:"column-name",sortable:!0,searchable:!0,valign:"middle"},{field:"user.email",title:i18n.t("blocklySharedFiles.fieldTitle.user"),sortable:!0,searchable:!1,valign:"middle"},{field:"modifyTime",title:i18n.t("blocklySharedFiles.fieldTitle.modifyTime"),sortable:!0,searchable:!1,valign:"middle",formatter:r}],url:"/api/users/sharedProjects?access_token="+Token.getId(),responseHandler:function(e){return e.map(function(e){return e.user.userIdentities&&(e.user.userIdentities.displayName&&""!==e.user.userIdentities.displayName.trim()?e.user.email=e.user.userIdentities.emails[0].value+" ("+e.user.userIdentities.displayName+")":e.user.email=e.user.userIdentities.emails[0].value),e})}}),s(),n=window.i18next.language,l=document.querySelector("#cloudUrl"),c=document.querySelector("#deviceUrl"),u=window.location.host.replace(/:[0-9].*$/,"").split("."),h=u.slice(u.length-2,u.length).join("."),Cookies.set("locale",n,{domain:h}),$("#language").val(n),l.search="lang="+n,c.search="lang="+n})}();